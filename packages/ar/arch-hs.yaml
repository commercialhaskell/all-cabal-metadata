homepage: https://github.com/berberman/arch-hs
changelog-type: markdown
hash: 3a879dfe3d3c964d745e46b5e7380cb5936868eddbd2f5f70280cb9490deece5
test-bench-deps: {}
maintainer: berberman <1793913507@qq.com>
synopsis: Distribute hackage packages to archlinux
changelog: |
  # Changelog

  `arch-hs` uses [PVP Versioning][1].
  The changelog is available [on GitHub][2].

  ## 0.5.0.0

  * Add `TargetDisappearException` to complain if target is clearly not reachable

  * Warn abnormal dependencies

  * Clear trace file if is not empty

  * Collect test dependencies recursively

  * Drop meaningless `alpm_errno_t`

  * Update name preset ([#30](https://github.com/berberman/arch-hs/pull/30) [#32](https://github.com/berberman/arch-hs/pull/32))

  * Fix a typo ([#29](https://github.com/berberman/arch-hs/pull/29))

  ## 0.4.0.0

  * [Alpm](https://www.archlinux.org/pacman/libalpm.3.html) support

  * Fix sub-libraries handling ([#22](https://github.com/berberman/arch-hs/issues/22))

  * Fix missing build tools ([#24](https://github.com/berberman/arch-hs/issues/24))

  * Fix flag comparison in diff ([#25](https://github.com/berberman/arch-hs/issues/25))

  * Fix pretty printing of flags

  * Update name preset ([#26](https://github.com/berberman/arch-hs/pull/26))

  ## 0.3.0.0

  * Update name preset

  * Add check in submit

  ## 0.2.0.0

  * More accurate naming conversion between hackage representation and archlinux representation, according to [NAME_PRESET.json](https://github.com/berberman/arch-hs/blob/master/data/NAME_PRESET.json)

  * Clearer project structure

  * More reasonable exceptions

  * Provide versions of haskell packages in archlinux community

  * Add `arch-hs-submit` executable

  ## 0.1.1.0

  * Add uusi option

  ## 0.1.0.0

  * Support sub-libraries ([#16](https://github.com/berberman/arch-hs/issues/16))

  * Split `arch-hs-uusi` into [`uusi`](https://github.com/berberman/uusi)

  * Better performance in dependency resolving

  * Fix recommended package order

  * Trace for dependency resolving

  * More reasonable PKGBUILD template ([#17](https://github.com/berberman/arch-hs/issues/16) [#18](https://github.com/berberman/arch-hs/issues/16) [#19](https://github.com/berberman/arch-hs/issues/16) [#20](https://github.com/berberman/arch-hs/issues/16))

  * Fix indentation of flags' pretty printing

  ## 0.0.0.0

  * Initially created.

  [1]: https://pvp.haskell.org
  [2]: https://github.com/berberman/arch-hs/releases
basic-deps:
  microlens-th: '>=0.4.3 && <0.5'
  bytestring: '>=0.10.10 && <0.11'
  split: '>=0.2.3 && <0.3'
  Cabal: '>=3.2.0 && <3.3'
  base: '>=4.14.0 && <4.15'
  text: '>=1.2.3 && <1.3'
  megaparsec: '>=8.0.0 && <8.1'
  filepath: '>=1.4.2 && <1.5'
  req: '>=3.8.0 && <3.9'
  conduit: '>=1.3.2 && <1.4'
  arch-hs: -any
  conduit-extra: '>=1.3.5 && <1.4'
  hackage-db: '>=2.1.0 && <2.2'
  containers: '>=0.6.2 && <0.7'
  tar-conduit: '>=0.3.2 && <0.4'
  colourista: ==0.1.*
  polysemy: -any
  optparse-applicative: '>=0.16.0 && <0.17'
  deepseq: '>=1.4.4 && <1.5'
  algebraic-graphs: ==0.5.*
  microlens: '>=0.4.11 && <0.5'
  aeson: '>=1.5.4 && <1.6'
  template-haskell: '>=2.16.0 && <2.17'
  neat-interpolation: '>=0.5.1 && <0.6'
  directory: '>=1.3.6 && <1.4'
all-versions:
- 0.0.0.0
- 0.1.0.0
- 0.1.1.0
- 0.2.0.0
- 0.3.0.0
- 0.4.0.0
- 0.5.0.0
author: berberman
latest: 0.5.0.0
description-type: markdown
description: "# arch-hs\n\n[![GitHub CI](https://github.com/berberman/arch-hs/workflows/CI/badge.svg)](https://github.com/berberman/arch-hs/actions)\n[![Build
  Status](https://travis-ci.com/berberman/arch-hs.svg?branch=master)](https://travis-ci.com/berberman/arch-hs)\n[![Hackage](https://img.shields.io/hackage/v/arch-hs.svg?logo=haskell)](https://hackage.haskell.org/package/arch-hs)\n[![MIT
  license](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)\n\nA program
  generating PKGBUILD for hackage packages. Special thanks to [felixonmars](https://github.com/felixonmars/).\n\n**Notice
  that `arch-hs` will always support only the latest GHC version.**\n\n\n## Introduction\n\nGiven
  the name of a package in hackage, `arch-hs` can generate PKGBUILD files, not only
  for the package\nwhose name is given, but also for all dependencies missing in [\\[community\\]](https://www.archlinux.org/packages/).\n`arch-hs`
  has a naive built-in dependency solver, which can fetch those dependencies and find
  out which are required to be packaged.\nDuring the dependency calculation, all version
  constraints will be discarded due to the arch haskell packaging strategy,\nthus
  there is no guarantee of dependencies' version consistency.\n\n## Prerequisite\n\n`arch-hs`
  is a PKGBUILD text file generator, which is not integrated with `pacman`(See [Alpm
  Support](#Alpm-Support)), depending on nothing than:\n\n* Pacman database (`community.db`)\n\n*
  Hackage index tarball (`01-index.tar`, or `00-index.tar` previously) -- usually
  provided by `cabal-install`\n\n## Installation\n\n`arch-hs` is portable, which means
  it's not restricted to Arch Linux.\nHowever, `arch-hs` can use libalpm to load pacman
  database on Arch Linux,\nand if you want to run them on other systems, you have
  to build it from source.\n\n### Install the latest release\n\n```\n# pacman -S arch-hs\n```\n\n`arch-hs`
  is available in [\\[community\\]](https://www.archlinux.org/packages/community/x86_64/arch-hs/),
  so you can install it using `pacman`.\n\n### Install the development version\n\n```\n#
  pacman -S arch-hs-git\n```\n\nThe `-git` version is available in [\\[archlinuxcn\\]](https://github.com/archlinuxcn/repo),
  following the latest git commit.\n\n## Build\n\n```\n$ git clone https://github.com/berberman/arch-hs\n```\n\nThen
  build it via stack or cabal.\n\n#### Stack\n```\n$ stack build\n```\n\n#### Cabal
  (dynamic)\n```\n$ cabal configure --disable-library-vanilla --enable-shared --enable-executable-dynamic
  --ghc-options=-dynamic \n$ cabal build\n```\n\n## Usage\n\nJust run `arch-hs` in
  command line with options and a target. Here is an example:\nwe will create the
  archlinux package of [accelerate](https://hackage.haskell.org/package/accelerate):\n\n```\n$
  arch-hs -o ~/test accelerate\n\n......\n\n  ⓘ Recommended package order (from topological
  sort):\n1. unique\n2. tasty-kat\n3. accelerate\n\n......\n\n  ⓘ Write file: /home/berberman/test/haskell-accelerate/PKGBUILD\n
  \ ⓘ Write file: /home/berberman/test/haskell-unique/PKGBUILD\n  ⓘ Write file: /home/berberman/test/haskell-tasty-kat/PKGBUILD\n
  \ ✔ Success!\n\n```\n\nThis message tells us that in order to package `accelerate`,
  we must package `unique`\nand `tasty-kat` first sequentially, because `accelerate`
  dependents on them to build or test,\nwhereas they are not present in archlinux
  \\[community\\] repo.\n\n```\n$ tree ~/test\n/home/berberman/Desktop/test\n├── haskell-accelerate\n│
  \  └── PKGBUILD\n├── haskell-tasty-kat\n│   └── PKGBUILD\n└── haskell-unique\n    └──
  PKGBUILD\n```\n\n`arch-hs` will generate PKGBUILD for each package. Let's see what
  we have in `./haskell-accelerate/PKGBUILD`:\n\n``` bash\n# This file was generated
  by arch-hs, please check it manually.\n# Maintainer: Your Name <youremail@domain.com>\n\n_hkgname=accelerate\npkgname=haskell-accelerate\npkgver=1.3.0.0\npkgrel=1\npkgdesc=\"An
  embedded language for accelerated array processing\"\nurl=\"https://github.com/AccelerateHS/accelerate/\"\nlicense=(\"custom:BSD3\")\narch=('x86_64')\ndepends=('ghc-libs'
  'haskell-ansi-terminal' 'haskell-base-orphans' 'haskell-cryptonite' 'haskell-half'
  'haskell-hashable' 'haskell-hashtables' 'haskell-hedgehog' 'haskell-lens' 'haskell-prettyprinter'
  'haskell-prettyprinter-ansi-terminal' 'haskell-primitive' 'haskell-tasty' 'haskell-terminal-size'
  'haskell-unique' 'haskell-unordered-containers' 'haskell-vector')\nmakedepends=('ghc'
  'haskell-doctest')\nsource=(\"https://hackage.haskell.org/packages/archive/$_hkgname/$pkgver/$_hkgname-$pkgver.tar.gz\")\nsha256sums=('4b97161f145c81f7554679802059598587e06d49b2c153e7bafc4dd6974bad92')\n\nbuild()
  {\n  cd $_hkgname-$pkgver\n\n  runhaskell Setup configure -O --enable-shared --enable-executable-dynamic
  --disable-library-vanilla \\\n    --prefix=/usr --docdir=/usr/share/doc/$pkgname
  --enable-tests \\\n    --dynlibdir=/usr/lib --libsubdir=\\$compiler/site-local/\\$pkgid
  \\\n    --ghc-option=-optl-Wl\\,-z\\,relro\\,-z\\,now \\\n    --ghc-option='-pie'\n\n
  \ runhaskell Setup build\n  runhaskell Setup register --gen-script\n  runhaskell
  Setup unregister --gen-script\n  sed -i -r -e \"s|ghc-pkg.*update[^ ]* |&'--force'
  |\" register.sh\n  sed -i -r -e \"s|ghc-pkg.*unregister[^ ]* |&'--force' |\" unregister.sh\n}\n\ncheck()
  {\n  cd $_hkgname-$pkgver\n  runhaskell Setup test\n}\n\npackage() {\n  cd $_hkgname-$pkgver\n\n
  \ install -D -m744 register.sh \"$pkgdir\"/usr/share/haskell/register/$pkgname.sh\n
  \ install -D -m744 unregister.sh \"$pkgdir\"/usr/share/haskell/unregister/$pkgname.sh\n
  \ runhaskell Setup copy --destdir=\"$pkgdir\"\n  install -D -m644 LICENSE -t \"$pkgdir\"/usr/share/licenses/$pkgname/\n
  \ rm -f \"$pkgdir\"/usr/share/doc/$pkgname/LICENSE\n}\n```\n\n`arch-hs` will collect
  the information from hackage db, and apply it into a fixed template after some processing
  steps\nincluding renaming, matching license, and filling out dependencies etc.\nHowever,
  packaging haven't been done so far.\n`arch-hs` may does well statically, but we
  should guarantee that this package can be built by ghc with the latest dependencies;\nhence
  some patchs may be required in `prepare()`, such as [uusi](#Uusi).\n\n\n## Options\n\n###
  Output\n\n```\n$ arch-hs -o ~/test TARGET\n```\n\nUsing `-o` can generate a series
  of PKGBUILD including `TARGET` with its dependencies into the output dir. If you
  don't pass it, only dependency calculation will occur.\n\n### Flag Assignments\n```\n$
  arch-hs -f TARGET:FLAG_A:true TARGET\n```\n\nUsing `-f` can pass flags, which may
  affect the results of resolving.  \n\n### AUR Searching\n\n```\n$ arch-hs -a TARGET\n```\n\nWith
  `-a`, `arch-hs` will regard AUR as another package provider, and it will try to
  search missing packages in AUR as well.\n\n### Skipping Components\n\n```\n$ arch-hs
  -s COMPONENT_A TARGET\n```\n\nUsing `-s` can force skip runnable components in dependency
  resolving.\nThis is useful when a package doesn't provide flag to disable its runnables,
  which will be built by default but are trivial in system level packaging.\nNotice
  that this only makes sense in the lifetime of `arch-hs`, whereas generated PKGBUILD
  and actual build processes will not be affected.\n\n### Extra Cabal Files\n\n```\n$
  arch-hs -e ~/TARGET/TARGET.cabal TARGET\n```\n\n**For Testing Purposes Only**\n\nUsing
  `-e` can include extra `.cabal` files as supplementary. Useful when the `TARGET`
  hasn't been released to hackage.\n\n### Trace\n\n```\n$ arch-hs --trace TARGET\n```\n\nWith
  `--trace`, `arch-hs` can print the process of dependency resolving into stdout.\n\n```\n$
  arch-hs --trace-file foo.log TARGET\n```\n\nSimilar to `--trace`, but the log will
  be written into a file.\n\n### Uusi\n\n```\n$ arch-hs -o ~/test --uusi TARGET\n```\n\nWith
  `--uusi`, `arch-hs` will generate following snippet for each package:\n\n```bash\nprepare()
  {\n  uusi $_hkgname-$pkgver/$_hkgname.cabal\n}\n```\n\nSee [uusi](https://hackage.haskell.org/package/uusi)
  for details.\n\n### Alpm\n\n```\n$ arch-hs --alpm TARGET\n```\n\nSee [Alpm Support](#Alpm-Support).\n\n\n##
  [Name preset](https://github.com/berberman/arch-hs/blob/master/data/NAME_PRESET.json)\n\nTo
  distribute a haskell package to archlinux, the name of package should be changed
  according to the naming convention:\n\n* for haskell libraries, their names must
  have `haskell-` prefix\n\n* for programs, it depends on circumstances\n\n* names
  should always be in lower case\n\nHowever, it's not enough to prefix the string
  with `haskell-` and transform to lower case; in some special situations, the hackage
  name\nmay have `haskell-` prefix already, or the case is irregular, thus we have
  to a name preset manually. Once a package distributed to archlinux,\nwhose name
  conform to above-mentioned situation, the name preset should be upgraded correspondingly.\n\n##
  Diff\n\n`arch-hs` also provides a component called `arch-hs-diff`. `arch-hs-diff`
  can show the differences of package description between two versions of a package.\nThis
  is useful in the subsequent maintenance of a package. Example:\n\n```\n$ arch-hs-diff
  HTTP 4000.3.14 4000.3.15\n  ▶ You didn't pass -f, different flag values may make
  difference in dependency resolving.\n  ⓘ Start running...\n  ⓘ Downloading cabal
  file from https://hackage.haskell.org/package/HTTP-4000.3.14/revision/0.cabal...\n
  \ ⓘ Downloading cabal file from https://hackage.haskell.org/package/HTTP-4000.3.15/revision/0.cabal...\nPackage:
  HTTP\nVersion: 4000.3.14  ⇒  4000.3.15\nSynopsis: A library for client-side HTTP\nURL:
  https://github.com/haskell/HTTP\nDepends:\n    base  >=4.3.0.0 && <4.14\n    time
  \ >=1.1.2.3 && <1.10\n    array  >=0.3.0.2 && <0.6\n    bytestring  >=0.9.1.5 &&
  <0.11\n    mtl  >=2.0 && <2.3\n    network  >=2.6 && <3.2\n    network-uri  ==2.6.*\n
  \   parsec  >=2.0 && <3.2\n--------------------------------------\n    base  >=4.3.0.0
  && <4.15\n    time  >=1.1.2.3 && <1.11\n    array  >=0.3.0.2 && <0.6\n    bytestring
  \ >=0.9.1.5 && <0.11\n    mtl  >=2.0 && <2.3\n    network  >=2.6 && <3.2\n    network-uri
  \ ==2.6.*\n    parsec  >=2.0 && <3.2\nMakeDepends:\n    HUnit  >=1.2.0.1 && <1.7\n
  \   deepseq  >=1.3.0.0 && <1.5\n    httpd-shed  >=0.4 && <0.5\n    mtl  >=1.1.1.0
  && <2.3\n    pureMD5  >=0.2.4 && <2.2\n    split  >=0.1.3 && <0.3\n    test-framework
  \ >=0.2.0 && <0.9\n    test-framework-hunit  >=0.3.0 && <0.4\nFlags:\n  HTTP\n    ⚐
  mtl1:\n      description:\n        Use the old mtl version 1.\n      default: False\n
  \     isManual: False\n    ⚐ warn-as-error:\n      description:\n        Build with
  warnings-as-errors\n      default: False\n      isManual: True\n    ⚐ conduit10:\n
  \     description:\n        Use version 1.0.x or below of the conduit package (for
  the test suite)\n      default: False\n      isManual: False\n    ⚐ warp-tests:\n
  \     description:\n        Test against warp\n      default: False\n      isManual:
  True\n    ⚐ network-uri:\n      description:\n        Get Network.URI from the network-uri
  package\n      default: True\n      isManual: False\n\n\n  ✔ Success!\n```\n\n`arch-hs-diff`
  does not require hackage db, it downloads cabal files from hackage server instead.
  \n\n## Submit\n\nFor hackage distribution maintainers only.\n\n## Limitations\n\n*
  `arch-hs` will run into error, if solved targets contain cycle. Indeed, circular
  dependency lies ubiquitously in hackage because of tests,\nbut basic cycles are
  resolved manually in \\[community\\] by maintainers. So after the provider simplification,
  `arch-hs` can eliminate these cycles.\nNevertheless, if the target introduces new
  cycle or it dependens on a package in an unknown cycle, `arch-hs` will throw `CyclicExist`
  exception.\n\n* `arch-hs` is not able to handle with complicated situations: the
  libraries of a package partially exist in hackage, some libraries include external
  sources, etc. \n\n* `arch-hs`'s functionality is limited to dependency processing,
  whereas necessary procedures like\nfile patches, version range processes, etc. They
  need to be done manually, so **DO NOT** give too much trust in generated PKGBUILD
  files.\n\n## Alpm Support\n\n[alpm](https://www.archlinux.org/pacman/libalpm.3.html)
  is Arch Linux Package Management library.\nWhen running on Arch Linux, loading `community.db`
  through this library is slightly faster than using the internal parser of `arch-hs`.\nThus,
  `arch-hs` provides a flag `alpm` to enable this feature:\n\n```\ncabal build -f
  alpm\n```\n\nThis flag is enabled by default in `arch-hs` Arch Linux package.\nCompiled
  with `alpm`, `arch-hs` can accept runtime flag `--alpm`.\n**That said, if you want
  to use alpm to boost `arch-hs`, you need compile `arch-hs` with cabal flag `alpm`,
  and pass `--aplm` to `arch-hs` when running.**\n> When `alpm` is enabled, `arch-hs`
  will lose the capability of specifying the path of `community.db`.\n\n## ToDoList\n\n-
  [ ] **Standardized pretty printing**.\n\n- [x] AUR support.\n\n- [x] Working with
  given `.cabal` files which haven't been released to hackage.\n\n\n## Contributing\n\nIssues
  and PRs are always welcome. **\\_(:з」∠)\\_**\n"
license-name: MIT
