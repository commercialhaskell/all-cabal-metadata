all-versions:
- 0.1.0.0
author: Hannes Siebenhandl, Wen Kokke, Matthew Pickering
basic-deps:
  base: '>=4.20 && <4.23'
  binary: '>=0.8.9.3 && <0.11'
  bytestring: '>=0.11 && <0.13'
  ghc-heap: '>=9.10.1 && <9.16'
  ghc-internal: '>=9.1001 && <9.1600'
  ghc-stack-profiler-core: ^>=0.1
  ghc-trace-events: ^>=0.1.2.10
  text: '>=2 && <2.2'
changelog: |
  # Revision history for ghc-stack-profiler

  ## 0.1.0.0 -- 2025-12-09

  * Adds API for sampling the RTS callstack and writing the results to the eventlog.
  * First version. Released on an unsuspecting world.
changelog-type: markdown
description: |-
  RTS Callstack profiler for GHC.

  The main idea is to periodically sample the Haskell callstack and use IPE and [stack annotation](https://www.well-typed.com/blog/2025/09/better-haskell-stack-traces/) information in order to understand the source locations which
  correspond to the stack frames.
  To profile a program it needs to be compiled and instrumented with the 'ghc-stack-profiler' package via:

  @
  import GHC.Stack.Profiler.Sampler

  main :: IO ()
  main = 'withStackProfilerForMyThread' ('SampleIntervalMs' 10) $ do
      ...
  @

  This will spawn a profiling thread that will periodically take a snapshot of the current RTS callstack of your program and serialises it to the eventlog.

  To improve readability of the profile, compile the program with @-finfo-table-map@ and @-fdistinct-constructor-tables@.
  Using @cabal@, this can be achieved with an appropriate @cabal.project@ file:

  @
  packages: ...

  ...

  package *
      ghc-options: -finfo-table-map -fdistinct-constructor-tables
  @

  To emit the eventlog messages by the profiler, you need to run your program with the @-l@ RTS flag, for example via:

  @
  ./\<program\> ... +RTS -l -RTS
  @

  This will write out an eventlog to @\<program\>.eventlog@ which can be transformed for [speedscope.app](https://www.speedscope.app/) via the script 'ghc-stack-profiler-speedscope'.

  @
  ghc-stack-profiler-speedscope \<program\>.eventlog
  @

  The resulting profile @\<program\>.eventlog.json@ can be viewed and further analysed in [speedscope.app](https://www.speedscope.app/).

  Note that the results are affected by compilation optimisation options, such as @-fno-omit-yields@.
description-type: haddock
hash: d4eb481b3b8452b4cdd12ca55c95c01b12cdb099a206fb9047e5ce79e8dbae61
homepage: ''
latest: 0.1.0.0
license-name: BSD-3-Clause
maintainer: hannes@well-typed.com
synopsis: RTS Callstack profiler for GHC.
test-bench-deps: {}
