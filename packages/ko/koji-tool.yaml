homepage: https://github.com/juhp/koji-tool
changelog-type: markdown
hash: 33cbe55f58599903fccd88d124ed0c32f5082af01e9d53b92b0360ffba15de4c
test-bench-deps:
  base: '>=4 && <5'
  simple-cmd: -any
maintainer: Jens Petersen <petersen@redhat.com>
synopsis: Koji CLI tool for querying tasks and installing builds
changelog: |
  # Version history of koji-tool

  ## 0.9.5 (2022-09-12)
  - 'install': fix determination of package name from srpm
  - 'progress': correctly determine NVR from srpm again

  ## 0.9.4 (2022-09-09)
  - 'install': rework install logic to combine reinstall and install pkgs
  - 'install': do not choose rebuildSRPM subtask
  - 'install': show correct top download dir
  - 'install': --add to specify additional package
  - 'install': change rpms prompt to require Enter for consistency with dnf
  - 'progress': another major logic refactor:
     determine poll delay from last-modified time
  - 'progress': skip wait for a build.log after [1..6] sec tries
  - 'progress': put interval times into task outputs
  - 'progress': only print task header if updated task outputs

  ## 0.9.3 (2022-08-03)
  - 'builds' for a package now use specified query options
  - 'builds': add --install and --tasks options
  - 'install': --exclude globs now filter --package globs
  - 'install': update installed subpackages first then install any new subpkgs
  - 'install': separate prompt logic for "install above" packages
  - 'install': experimental support for rpm-ostree overlaying (--rpm-ostree)
  - 'install': allow noarch tasks
  - 'install': allow package filtering in --list mode
  - 'install': --skip-existing to leave already installed subpackages untouched
  - 'progress' records the largest finished build.log size
  - 'progress': exclude srpm from max log sizes
  - 'progress': show pkg name instead of "unknown" nvr early on
  - 'progress': only use current time if task unfinished
  - 'tasks': fix output url selection for scratch builds
  - 'tasks': check build.log exists before getting its size
  - make parsing of states strict for earlier errors
  - error if koji userid not found

  ## 0.9.2 (2022-06-12)
  - tasks --install now takes install options string
  - install: place rpms in a nvr subdirectory
  - install: when downloading check if local files' timestamp within build time
  - progress: no longer quit after srpm build
  - progress: show duration of build and finished tasks

  ## 0.9.1 (2022-05-29)
  - 'find': add "install", "tail", "notail", and archs support
  - 'install': --rpm option to install directly with rpm instead of dnf
  - 'tasks': add --install option
  - 'tasks': major rework of the log file handling
  - 'tasks --tail': fix output when task still running
  - 'tasks': compact output shows duration
  - 'builds': now outputs packages archive url

  ## 0.9 (2022-05-20)
  - rename 'quick' command to 'find'
  - 'builds': compact output now appends url
  - 'find': add "details" word

  ## 0.8.7 (2022-05-14)
  'quick' enhancements:
  - better help
  - support "current" state for ongoing jobs
  - --debug flag
  - an extra unknown word is now taken to be a package name
  - append "\'s" to a username to search for their build tasks

  ## 0.8.6 (2022-05-13)
  - new 'quick' command for a few limited common searchs
  - install: --prefix to set subpackage prefix if different to package basename
  - install: fix infinite loop when no match for subpackage glob

  ## 0.8.5 (2022-05-10)
  - use rpm-nvr-0.1.2 for better NVR and NVRA parsing ensuring non-empty names
  - when parsing koji build request fields, detect git hash and fork builds

  ## 0.8.4 (2022-05-09)
  - Install: completely rework logic using installed status and NVRA etc
  - install: '--no-reinstall' replaces '--reinstall-nvrs'
  - install: determine package name from child or parent task
  - Install: confirm for --all and --exclude, respecting --yes
  - tasks: parse taskid as arg and drop --task and --children
  - Tasks: print parent Task taskid compactly and then its children

  ## 0.8.3 (2022-04-23)
  - 'latest': new cmd to list latest package build for tag
  - 'install': use --reinstall-nvrs to reinstall rpms for current nvr
  - 'install': now prompts before proceeding
  - 'install': handle build tasks by finding buildArch
  - 'install': --list now always lists rpms

  ## 0.8.2 (2022-03-28)
  - use the formatting library for rendering aligned output

  ## 0.8.1 (2022-03-21)
  - query results ordered by taskid or buildid for speed
  - 'builds', 'tasks': argument is now a package otherwise use --pattern (replaces --package)
  - 'install': add a --yes option to avoid questions (#2)
  - print archs appended with '.' prefix

  ## 0.8 (2022-03-02)
  - rename 'query' to 'tasks'
  - 'tasks': new '--tail' option to fetch and display tail of build.log
    (shows root.log instead if build.log is too small)
  - 'tasks': extend list of methods and list them in --method help
  - new 'builds' query command (replaces 'tasks' builds listing)
  - only query print date when option given by user
  - --debug now displays query options
  - 'tasks' and 'builds' now use --hub like 'install'
  - new --mine (self-user) option (instead of defaulting to mine)
  - 'tasks' and 'builds' support build NVR pattern search (requires Koji 1.24+)
  - 'tasks' and 'builds' have --details option otherwise output is compact
    (unless there is a single result)

  ## 0.7 (2022-01-25)
  - query: new options: '--package' to search recent builds and '--latest'
  - query --method: now defaults to buildArch (use 'any' to include all)
  - query: now defaults to "--before now" (instead of "--from today 00:00")
  - query --arch: map i686 to i386 and armv7hl to armhfp
  - query: do not drop tasks without string request

  ## 0.6.1 (2022-01-14)
  - install --list: now lists the rpms of a unique nvr
  - install --list: new --latest option which only finds the latest build
  - install --nv: now actually looks for N-V nor N-V-R
  - install --exclude: don't exclude subpackage when a rpm package matches

  ## 0.6 (2022-01-13)
  - renamed from koji-install to koji-tool, which combines koji-query and koji-progress
  - subcommands are 'install', 'query', 'progress', and 'buildlog-sizes'
  - 'query' now has separate before/after options: --before and --from
  - 'query' now defaults to '--from 00:00' and supports days of week & today/yesterday timedates
  - 'query' now limits to 10 results by default in descending order
  - 'install' now uses a single curl invocation to download multiple rpms

  # Release history for koji-install

  ## 0.5 (2021-12-27)
  - --package and --exclude filters can now be combined
  - --package and --exclude now also check subpackage names without base prefix

  ## 0.4 (2021-12-20)
  - support installing/listing by koji taskid
  - select subpackages with --package and --exclude, by name or globbing
  - check remote files date/size with http-directory
  - listing a task either lists the task's children or rpms
  - use dnf reinstall for installed packages and otherwise localinstall
  - more detailed debug output
  - system arch no longer hardcoded to x86_64

  ## 0.3 (2021-12-03)
  - add `--list` command to list recent builds
  - fix bug in generating kojifiles url from short name
  - workarounds for rpmfusion's older koji not supporting patterns
  - check if %dist is defined

  ## 0.2.0 (2021-12-03)
  - initial Hackage release
  - `--hub` to select hub
  - `--pkgsurl` to override kojifiles url
  - override `--disttag`
  - select specific build with `--nvr` or `--nv`
  - `--debug` output

  ## 0.1.0 (2021-08-12)
  - pre-release on copr
  - initial options:
    --all/--ask/--base-only/--exclude-devel --dry-run
  - only supports Fedora Koji
basic-deps:
  extra: -any
  base: <5
  time: '>=1.9.1'
  text: -any
  http-common: <0.8.3.4
  rpm-nvr: '>=0.1.2'
  simple-cmd-args: '>=0.1.8'
  filepath: -any
  http-directory: '>=0.1.10'
  koji: '>=0.0.2'
  utf8-string: -any
  formatting: '>=7'
  pretty-simple: -any
  xdg-userdirs: -any
  http-conduit: -any
  Glob: -any
  simple-cmd: '>=0.2.2'
  directory: -any
all-versions:
- '0.6'
- 0.6.1
- '0.7'
- '0.8'
- 0.8.1
- 0.8.2
- 0.8.3
- 0.8.4
- 0.8.5
- 0.8.6
- 0.8.7
- '0.9'
- 0.9.1
- 0.9.2
- 0.9.3
- 0.9.4
- 0.9.5
author: Jens Petersen <petersen@redhat.com>
latest: 0.9.5
description-type: markdown
description: |
  # koji-tool

  A CLI UI to the [Koji](https://koji.fedoraproject.org/koji/) buildsystem
  with commands to query builds and tasks, install rpms,
  and check buildlog sizes.

  [Koji](https://pagure.io/koji/) is the RPM package buildsystem used by
  Fedora Linux, CentOS, and some other projects.

  By default Fedora Koji is used.

  A few illustrative examples:

  `koji-tool tasks --mine --latest --state fail --tail`:
  shows details of your last buildArch failure and the tail of the build.log
  (equivalently you can use `koji-tool find my last fail`).

  `koji-tool install systemd`: will try to install or update to the newest rpm packages from koji.

  `koji-tool builds -L -s complete firefox`:
  shows the last successful build with a url and other details.

  ## Commands
  ```shellsession
  $ koji-tool --version
  0.9.5
  $ koji-tool --help
  Query and track Koji tasks, and install rpms from Koji.

  Usage: koji-tool [--version] COMMAND
    see https://github.com/juhp/koji-tool#readme

  Available options:
    -h,--help                Show this help text
    --version                Show version

  Available commands:
    builds                   Query Koji builds (by default lists the most recent
                             builds)
    tasks                    Query Koji tasks (by default lists the most recent
                             buildArch tasks)
    latest                   Query latest Koji build for tag
    install                  Install rpm packages directly from a Koji build task
    progress                 Track running Koji tasks by buildlog size
    buildlog-sizes           Show buildlog sizes for nvr patterns
    find                     Simple quick common queries using words like: [my,
                             last, fail, complete, current, build, detail,
                             install, tail, notail, x86_64, PACKAGE, USER\'s]
  ```

  ## koji-tool builds

  Query Koji for builds.

  Somewhat like `koji list-builds --quiet ...`,
  but it shows duration, and kojiweb urls.
  It uses `date` to parse a specified date string
  and can use an NVR glob pattern to select builds.

  Note results are ordered by build_id (not time) for speed.

  ### Usage

  By default lists up to 10 Fedora Koji builds.

  ```shellsession
  $ koji-tool builds --help
  Usage: koji-tool builds [-H|--hub HUB] [(-u|--user USER) | (-M|--mine)]
                          [(-L|--latest) | (-l|--limit INT)] [-s|--state STATE]
                          [(-B|--before TIMESTAMP) | (-F|--from TIMESTAMP)]
                          [-T|--type TYPE] [(-d|--details) | (-t|--tasks)]
                          [-i|--install INSTALLOPTS] [-D|--debug]
                          [(-b|--build NVR/BUILDID) | (-p|--pattern NVRPAT) |
                            PACKAGE]
    Query Koji builds (by default lists the most recent builds)

  Available options:
    -H,--hub HUB             KojiHub shortname or url (HUB = fedora, stream,
                             rpmfusion, or URL) [default: fedora]
    -u,--user USER           Koji user
    -M,--mine                Your tasks (krb fasid)
    -L,--latest              Latest build
    -l,--limit INT           Maximum number of builds to show [default: 10]
    -s,--state STATE         Filter builds by state
                             (building,complete,deleted,fail(ed),cancel(ed)
    -B,--before TIMESTAMP    Builds completed before timedate [default: now]
    -F,--from TIMESTAMP      Builds completed after timedate
    -T,--type TYPE           Select builds by type: all,image,maven,module,rpm,win
    -d,--details             Show more build details
    -t,--tasks               Show details and tasks
    -i,--install INSTALLOPTS Install the package with 'install' options
    -D,--debug               Pretty-print raw XML result
    -b,--build NVR/BUILDID   Show build
    -p,--pattern NVRPAT      Builds matching glob pattern
    -h,--help                Show this help text
  ```

  Examples:

  ```shellsession
  $ koji-tool builds -M -s fail
  ```
  lists your recent builds that failed.

  List latest build of a package:
  ```shellsession
  $ koji-tool builds --pattern redhat-rpm-config*.fc37 --latest

  redhat-rpm-config-218-1.fc37 BuildComplete
  https://koji.fedoraproject.org/koji/buildinfo?buildID=1963037
  https://koji.fedoraproject.org/koji/taskinfo?taskID=86677797
  Start: Thu May  5 19:02:33 +08 2022
  End:   Thu May  5 19:04:26 +08 2022
  duration: 0h 1m 53s
  ```

  ## koji-tool tasks

  Query Koji for tasks.

  Somewhat like `koji list-tasks --quiet --all ...`,
  but it shows duration, kojiweb urls and build.log size,
  and it uses `date` to parse a specified date string
  and can filter task results by package or nvr prefix.

  Note results are ordered by task id (not time) for speed.

  ### Usage

  By default it lists 10 most recent Fedora Koji buildArch tasks.

  ```shellsession
  $ koji-tool tasks --help
  Usage: koji-tool tasks [-H|--hub HUB] [(-u|--user USER) | (-M|--mine)]
                         [(-L|--latest) | (-l|--limit INT)] [-s|--state STATE]
                         [-a|--arch ARCH]
                         [(-B|--before TIMESTAMP) | (-F|--from TIMESTAMP)]
                         [-m|--method METHOD] [-d|--details] [-D|--debug]
                         [(-P|--only-package PKG) | (-N|--only-nvr PREFIX)]
                         [-T|--tail] [-i|--install INSTALLOPTS]
                         [(-b|--build BUILD) | (-p|--pattern NVRPAT) |
                           PACKAGE|TASKID]
    Query Koji tasks (by default lists the most recent buildArch tasks)

  Available options:
    -H,--hub HUB             KojiHub shortname or url (HUB = fedora, stream,
                             rpmfusion, or URL) [default: fedora]
    -u,--user USER           Koji user
    -M,--mine                Your tasks (krb fasid)
    -L,--latest              Latest build or task
    -l,--limit INT           Maximum number of tasks to show [default: 10]
    -s,--state STATE         Filter tasks by state
                             (open,close(d),cancel(ed),fail(ed),assigned,free)
    -a,--arch ARCH           Task arch
    -B,--before TIMESTAMP    Tasks completed before timedate [default: now]
    -F,--from TIMESTAMP      Tasks completed after timedate
    -m,--method METHOD       Select tasks by method (default 'buildArch'):
                             all,appliance,build,buildArch,buildContainer,buildMaven,buildNotification,buildSRPMFromSCM,chainbuild,chainmaven,createAppliance,createContainer,createImage,createLiveCD,createLiveMedia,createdistrepo,createrepo,dependantTask,distRepo,image,indirectionimage,livecd,livemedia,maven,newRepo,rebuildSRPM,runroot,tagBuild,tagNotification,vmExec,waitrepo,winbuild,wrapperRPM
    -d,--details             Show more details of builds
    -D,--debug               Pretty-print raw XML result
    -P,--only-package PKG    Filter task results to specified package
    -N,--only-nvr PREFIX     Filter task results by NVR prefix
    -T,--tail                Fetch the tail of build.log
    -i,--install INSTALLOPTS Install the package with 'install' options
    -b,--build BUILD         List child tasks of build
    -p,--pattern NVRPAT      Build tasks of matching pattern
    -h,--help                Show this help text
  ```

  Examples:

  ```shellsession
  $ koji-tool tasks -M -a aarch64 -s fail
  ```
  lists your recent arm64 tasks that failed.

  Show latest newRepo task:
  ```shellsession
  $ koji-tool tasks --method newrepo --latest

  eln-build newRepo TaskClosed
  https://koji.fedoraproject.org/koji/taskinfo?taskID=86821565
  Start: Mon May  9 11:53:53 +08 2022
  End:   Mon May  9 11:57:13 +08 2022
  duration: 0h 3m 20s
  ```

  List latest package build's tasks:
  ```shellsession
  $ koji-tool tasks --latest redhat-rpm-config

  redhat-rpm-config-218-1.eln118.noarch TaskClosed
  https://koji.fedoraproject.org/koji/taskinfo?taskID=86685316 (parent: 86685296)
  Start: Fri May  6 00:11:10 +08 2022
  End:   Fri May  6 00:13:07 +08 2022
  duration: 0h 1m 57s
  https://kojipkgs.fedoraproject.org/work/tasks/5316/86685316/build.log (13kB)
  ```

  It is also possible to install packages from a task using `--install "..."`.
  See the install command documentation below for more details.

  ## koji-tool install

  Download and install rpms from a Koji build or task.

  By default it only downloads binaries of already-installed subpackages,
  but there are options to list and select or exclude specific subpackages.

  Note this command is intended for development and testing purposes
  and should not be necessary/used normally on production systems,
  but it can be very helpful for quickly testing an specific package build or
  update locally.

  ### Usage

  ```shellsession
  $ koji-tool install podman
  ```
  will download the latest build for your Fedora version,
  and try to install it.
  Use `--disttag` suffix to select a different Fedora version.

  ```shellsession
  $ koji-tool install TASKID --exclude "*-devel"
  ```
  will install all the non-devel subpackages from the task.

  A more complex example:
  ```shellsession
  $ koji-tool install google-noto-fonts --prefix google-noto -p 'sans-*-vf-fonts' -x 'sans-*-ui-vf-fonts'
  ```
  installs all the Google Noto Sans variable fonts excluding UI faces.

  One can use `--hub` to specify a different Koji hub build service.

  #### Selecting subpackages

  By default only installed subpackages are downloaded and updated,
  but the following options change the behavior:

  `--package`: select subpackages by name or glob pattern (this doesn't work currently for multiple builds/tasks)

  `--exclude`: exclude subpackages by name or glob pattern

  `--all`: install all subpackages

  `--ask`: ask about each subpackage

  `--prefix`: override the subpackage prefix

  ### Help
  ```shellsession
  $ koji-tool install --help
  Usage: koji-tool install [-n|--dry-run] [-D|--debug] [-y|--yes] [-H|--hub HUB]
                           [-P|--packages-url URL] [-l|--list] [-L|--latest]
                           [-t|--check-remote-time] [--rpm | --rpm-ostree | --dnf]
                           [(-N|--no-reinstall) | (-S|--skip-existing)]
                           [-b|--prefix SUBPKGPREFIX]
                           [--all | --ask | [-p|--package SUBPKG]
                             [-a|--add SUBPKG] [-x|--exclude SUBPKG]]
                           [-d|--disttag DISTTAG] [(-R|--nvr) | (-V|--nv)]
                           PKG|NVR|TASKID...
    Install rpm packages directly from a Koji build task

  Available options:
    -n,--dry-run             Don't actually download anything
    -D,--debug               More detailed output
    -y,--yes                 Assume yes to questions (implies --all if not
                             installed)
    -H,--hub HUB             KojiHub shortname or url (HUB = fedora, stream,
                             rpmfusion, or URL) [default: fedora]
    -P,--packages-url URL    KojiFiles packages url [default: Fedora]
    -l,--list                List builds
    -L,--latest              Latest build
    -t,--check-remote-time   Check remote rpm timestamps
    --rpm                    Use rpm instead of dnf
    --rpm-ostree             Use rpm-ostree instead of dnf
    --dnf                    Use dnf to install [default unless ostree]
    -N,--no-reinstall        Do not reinstall existing NVRs
    -S,--skip-existing       Ignore already installed subpackages (implies
                             --no-reinstall)
    -b,--prefix SUBPKGPREFIX Prefix to use for subpackages [default: base package]
    --all                    all subpackages
    --ask                    ask for each subpackge [default if not installed]
    -p,--package SUBPKG      Subpackage (glob) to install
    -a,--add SUBPKG          Additional subpackage (glob) to install
    -x,--exclude SUBPKG      Subpackage (glob) not to install
    -d,--disttag DISTTAG     Select a disttag different to system
    -R,--nvr                 Give an N-V-R instead of package name
    -V,--nv                  Give an N-V instead of package name
    -h,--help                Show this help text
  ```

  ## koji-tool find
  This provides shortcuts to a few select common searches

  ### Usage
  `koji-tool find my builds` shows your 10 most recent koji builds (equivalent to `koji-tool builds --mine`)

  `koji-tool find my last fail` shows your most recent task failure including the tail of the build.log (equivalent to `koji-tool tasks -MLT -s fail`).

  `koji-tool find last complete build` shows the latest completed koji build (equivalent to `koji-tool builds -L -s complete`).

  ### Help
  ```shellsession
  $ koji-tool find
  koji-tool: find handles these words:

  my mine
  last latest
  fail failure failed
  complete completed completion close closed finish finished
  current building open
  build builds
  detail details detailed
  install
  tail
  notail
  x86_64 aarch64 ppc64le s390x i686 armv7hl
  PACKAGE
  USER\'s

  ```

  ## koji-tool progress
  Shows the progress of active koji builds tasks
  by checking the size of their build.log files.

  This is useful for monitoring the build progress of large packages that take
  a long time to complete for which some arch's may take considerably longer.

  ### Usage

  ```shellsession
  $ koji-tool progress --mine
  :
  $ koji-tool progress 81148584  # ← Koji taskid
  :
  23:19:19 vim-8.2.4068-1.fc36 (81148584)
  aarch64    351kB [109,133 B/min]
  armhfp     133kB [ 65,244 B/min]
  ppc64le    493kB [141,598 B/min] TaskClosed
  s390x      558kB [100,481 B/min] TaskClosed
  :
  ```

  The `buildlog-sizes` command is similar but runs once over nvr patterns.

  ## Installation
  koji-tool is packaged in Fedora

  ## Build
  `cabal-rpm builddep && cabal install || stack install`

  ## History
  The query, install, progress, buildlog-sizes were originally separate programs
  and projects (koji-query, koji-install, koji-progress),
  and merged together into koji-install (after 0.5) and renamed
  to koji-tool. See the other original repos for their history.
license-name: BSD-3-Clause
