all-versions:
- 1.1.1
author: pe200012
basic-deps:
  aeson: '>=2.1 && <2.3'
  async: '>=2.2 && <2.3'
  base: '>=4.7 && <4.22'
  base64: '>=1.0 && <1.1'
  bytestring: '>=0.11 && <0.13'
  co-log: '>=0.6 && <0.8'
  co-log-core: '>=0.3 && <0.4'
  co-log-polysemy: '>=0.0.1.5 && <0.0.2'
  conduit: '>=1.3 && <1.4'
  containers: '>=0.6 && <0.8'
  crypton: '>=1.0 && <1.1'
  crypton-connection: '>=0.4 && <0.5'
  crypton-x509: '>=1.7 && <1.8'
  crypton-x509-store: '>=1.6 && <1.7'
  cryptostore: '>=0.3 && <0.4'
  dhall: '>=1.42 && <1.43'
  directory: '>=1.3 && <1.4'
  exceptions: '>=0.10 && <0.11'
  extra: '>=1.7 && <1.9'
  filepath: '>=1.4 && <1.6'
  hex-text: '>=0.1 && <0.2'
  hs-hath: '>=0'
  http-client: '>=0.7 && <0.8'
  http-client-tls: '>=0.3 && <0.4'
  http-conduit: '>=2.3 && <2.4'
  http-media: '>=0.8 && <0.9'
  http-types: '>=0.12 && <0.13'
  lrucache: '>=1.2 && <1.3'
  mason: '>=0.2.6 && <0.3'
  memory: '>=0.18 && <0.19'
  monad-control: '>=1.0 && <1.1'
  monad-loops: '>=0.4 && <0.5'
  mtl: '>=2.3 && <2.4'
  network: '>=3.1 && <3.3'
  optparse-applicative: '>=0.18 && <0.19'
  polysemy: '>=1.9 && <1.10'
  polysemy-zoo: '>=0.8 && <0.9'
  process: '>=1.6 && <1.7'
  relude: '>=1.2 && <1.3'
  resourcet: '>=1.3 && <1.4'
  safe-exceptions: '>=0.1 && <0.2'
  servant: '>=0.20.2 && <0.21'
  servant-client: '>=0.20.2 && <0.21'
  servant-client-core: '>=0.20.2 && <0.21'
  servant-server: '>=0.20.2 && <0.21'
  sqlite-simple: '>=0.4 && <0.5'
  stm: '>=2.5 && <2.6'
  string-interpolate: '>=0.3 && <0.4'
  suspend: '>=0.2 && <0.3'
  template-haskell: '>=2.19 && <2.24'
  text: '>=2.0 && <2.2'
  time: '>=1.12 && <1.15'
  timers: '>=0.2 && <0.3'
  tls: '>=2.0 && <2.4'
  tls-session-manager: '>=0.0.5 && <0.1'
  transformers: '>=0.6 && <0.7'
  unix: '>=2.8 && <2.9'
  unliftio: '>=0.2 && <0.3'
  unordered-containers: '>=0.2 && <0.3'
  wai: '>=3.2 && <3.3'
  wai-extra: '>=3.1 && <3.2'
  warp: '>=3.4 && <3.5'
changelog: |
  # Changelog for `hs-hath`

  All notable changes to this project will be documented in this file.

  The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
  and this project adheres to the
  [Haskell Package Versioning Policy](https://pvp.haskell.org/).

  ## [1.1.1] - 2026-01-26

  ### Added
  - R2 Object Storage support with client-side caching
  - Presigned URL generation for R2 redirects

  ### Changed
  - Refactored time handling to use MonotonicTime for better precision
  - Fix rate limiting logic
  - Drop macOS support (removed logic-macos.hs)

  ## [1.0.3] - 2026-01-24

  ### Added
  - Custom Prometheus metrics implementation with counters and gauges
  - Metrics registry and snapshot mechanism for efficient metrics collection
  - Non-blocking metrics retrieval endpoint with background worker
  - stack-release.yaml for optimized release builds with LLVM support
  - Aggressive optimization options for release builds

  ### Changed
  - **Performance:** Improved rate limiting by removing TVar dependency and simplifying architecture
  - **Performance:** Refactored to use monotonic time, avoiding complex UTCTime calculations
  - Removed development logging statements
  - Removed redundant imports
  - Automated release process with GitHub Actions (separate build and release jobs)
  - Removed dependency on `prometheus` and `binary` packages in favor of custom implementation

  ### Fixed
  - Fixed config validation option to take effect properly

  ## [1.0.2] - 2026-01-23

  ### Added
  - Gallery downloader task queue for better task management
  - Filesystem cache backend as an alternative storage option
  - Admin settings endpoint for runtime configuration
  - Configuration validation and LRU cache tuning capabilities
  - Enhanced logging for gallery downloader errors and failed tasks

  ### Changed
  - **Performance:** Refactored hashing to use type classes for better abstraction
  - **Performance:** Reduced intermediate ByteString allocations in hot paths
  - **Performance:** Shared global HTTP manager across requests to reduce overhead
  - **Performance:** Optimized buffer allocation strategies
  - **Performance:** Improved hashing performance for security tokens
  - Switched to monotonic clock for more accurate uptime tracking
  - Refactored server loop for better code structure and maintainability
  - Improved download retry logic with better error handling
  - Improved gallery download resilience and error recovery
  - Split middlewares into separate modules for better organization
  - Enhanced CI workflow for Haskell projects

  ### Fixed
  - Fixed keystamp rate limiting implementation
  - Bypassed staticRanges check in Locate.hs to resolve compatibility issues
  - Worked around encoding errors in gallery processing
  - Added existence checks before processing to avoid redundant work

  ## [1.0.1] - 2026-01-20

  ### Added
  - Statistics tracking with Prometheus metrics integration
  - Prometheus package dependency for metrics collection
  - Gallery downloader implementation
  - Stats effect constructors for new metrics types
  - Release workflow automation (release.yml)
  - GHC build caching in CI

  ### Changed
  - Refactored TrafficStats from TVar to Prometheus Registry
  - Refactored settings handling for dynamic runtime updates
  - Refactored signal handling and removed verification step
  - DRY improvements for LRU cache implementation
  - Refactored module structures for better organization
  - Updated README with comprehensive documentation

  ### Fixed
  - Fixed threaded speedtest issues

  ### Removed
  - Removed Windows release targets

  ## [1.0.0] - 2026-01-19

  ### Added
  - Initial release with keystamp-based rate limiting
  - Core H@H (Hentai@Home) server functionality
  - RPC client for H@H network communication
  - SQLite and R2 storage backends with runtime switching
  - File integrity verification with streaming to prevent space leaks
  - In-memory LRU cache for R2 backend
  - Docker support for containerized deployment
  - Trust-proxy-headers option for real IP handling
  - Migrate-to-R2 tool for backend migration
  - Command-line interface with configuration options
  - Traffic statistics tracking and reporting
  - Graceful shutdown handling
  - TLS support with certificate management
  - Environment variable configuration (HATH_RPC_HOST, base URL)

  ### Changed
  - Upgraded to GHC 9.6.7 and resolver lts-22.44
  - SQLite journal mode changed to delete for better compatibility
  - Switched from static linking to dynamic linking
  - Widened aeson version bounds for better compatibility

  ### Fixed
  - Resolved space leak in checkRate function
  - Fixed space leak in file verification by using streaming approach
changelog-type: markdown
description: "# hs-hath - A Haskell Implementation of the Hentai@Home Client\n\n[![License:
  GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0)\n\nA
  high-performance Haskell implementation of the Hentai@Home client. The client caches
  and serves gallery files, communicates with the H@H server via TLS-secured RPC,
  and supports S3-compatible storage backends including Cloudflare R2.\n\n## Features\n\nResource
  caching uses an LRU cache with SQLite-backed or R2-backed storage. RPC communication
  to the H@H server uses TLS with automatic certificate refresh every 24 hours. Rate
  limiting includes both IP-based throttling and keystamp-based fallback for NAT environments.
  Gallery downloads support parallel file fetching. Prometheus metrics are available
  at the `/metrics` endpoint. The client tracks build information via the `--version`
  flag.\n\n## Installation\n\n### Prerequisites\n- Stack (Haskell toolchain)\n- SQLite
  3\n- OpenSSL libraries\n\n### Building\n```bash\ngit clone https://github.com/pe200012/hs-hath.git\ncd
  hs-hath\nstack build\n```\n\n## Configuration\n\nCreate a `client-login` file with
  your credentials:\n```dhall\n{ clientId = \"your-client-id\"\n, key = \"your-api-key\"
  \n, version = \"1.0.0\"\n, proxy = None ClientProxy\n, downloadDir = \"./downloads\"\n,
  cachePath = \"./cache.db\"\n}\n```\n\n## Usage\n\nStart the client:\n```bash\nstack
  exec hs-hath\n```\n\nView version information:\n```bash\nstack exec hs-hath -- --version\n```\n\nThe
  client responds to `SIGINT` and `SIGTERM` for graceful shutdown. Settings reload
  automatically via RPC command. The Prometheus metrics endpoint is available at `/metrics`
  for monitoring.\n\n## Architecture\n\nThe RPC client handles communication with
  the H@H server, including certificate management and settings synchronization. The
  resource cache stores files using SQLite with LRU eviction. An HTTP server built
  on Warp serves cached resources. Rate limiting middleware provides both IP-based
  and keystamp-based request throttling. The storage backend supports local filesystem
  and S3-compatible services like Cloudflare R2.\n\n## Metrics\n\nThe client exports
  Prometheus metrics in text format at the `/metrics` endpoint. Metrics include request
  counters, cache statistics, and operational counters for monitoring and alerting.\n\n##
  Performance\n\nHas not been optimized yet. Currently, it will take ~200MiB RAM on
  average.\n\n## Troubleshooting\n\n### Certificate errors\nVerify system clock synchronization
  and certificate file permissions. Certificate refresh occurs automatically every
  24 hours.\n\n### Connection issues\nCheck proxy settings if configured. Ensure firewall
  allows outbound TLS connections on the required ports.\n\n### Storage backend errors\nFor
  S3-compatible backends like Cloudflare R2, verify that the storage server returns
  required headers: `ETag`, `Content-Length`, and `Last-Modified`. Missing `ETag`
  headers cause write failures.\n\n### Rate limiting\nThe client implements strict
  request throttling. Banned IPs and rate limit violations appear in console logs.
  Verify client configuration if legitimate requests are being rejected.\n\n## License\n\nThis
  project is licensed under the GNU General Public License v3.0 - see the [LICENSE](LICENSE)
  file for details.\n"
description-type: markdown
hash: e8105cc1046ded50b6e8dfb7d73b6055c5d4ee6f77a7fca931f1fa9bf3c32cc4
homepage: https://github.com/pe200012/hs-hath#readme
latest: 1.1.1
license-name: GPL-3.0-only
maintainer: 1326263755@qq.com
synopsis: A Haskell implementation of the Hentai@Home client
test-bench-deps:
  aeson: '>=2.1 && <2.3'
  async: '>=2.2 && <2.3'
  base: '>=4.7 && <4.22'
  base64: '>=1.0 && <1.1'
  bytestring: '>=0.11 && <0.13'
  co-log: '>=0.6 && <0.8'
  co-log-core: '>=0.3 && <0.4'
  co-log-polysemy: '>=0.0.1.5 && <0.0.2'
  conduit: '>=1.3 && <1.4'
  containers: '>=0.6 && <0.8'
  crypton: '>=1.0 && <1.1'
  crypton-connection: '>=0.4 && <0.5'
  crypton-x509: '>=1.7 && <1.8'
  crypton-x509-store: '>=1.6 && <1.7'
  cryptostore: '>=0.3 && <0.4'
  dhall: '>=1.42 && <1.43'
  directory: '>=0'
  exceptions: '>=0.10 && <0.11'
  extra: '>=1.7 && <1.9'
  filepath: '>=0'
  hex-text: '>=0.1 && <0.2'
  hs-hath: '>=0'
  hspec: '>=2.11 && <2.12'
  http-client: '>=0.7 && <0.8'
  http-client-tls: '>=0.3 && <0.4'
  http-conduit: '>=2.3 && <2.4'
  http-media: '>=0.8 && <0.9'
  http-types: '>=0.12 && <0.13'
  lrucache: '>=1.2 && <1.3'
  mason: '>=0.2.6 && <0.3'
  memory: '>=0.18 && <0.19'
  monad-control: '>=1.0 && <1.1'
  monad-loops: '>=0.4 && <0.5'
  mtl: '>=2.3 && <2.4'
  network: '>=3.1 && <3.3'
  optparse-applicative: '>=0.18 && <0.19'
  polysemy: '>=1.9 && <1.10'
  polysemy-zoo: '>=0.8 && <0.9'
  process: '>=1.6 && <1.7'
  relude: '>=1.2 && <1.3'
  resourcet: '>=1.3 && <1.4'
  safe-exceptions: '>=0.1 && <0.2'
  servant: '>=0.20.2 && <0.21'
  servant-client: '>=0.20.2 && <0.21'
  servant-client-core: '>=0.20.2 && <0.21'
  servant-server: '>=0.20.2 && <0.21'
  sqlite-simple: '>=0.4 && <0.5'
  stm: '>=2.5 && <2.6'
  string-interpolate: '>=0.3 && <0.4'
  suspend: '>=0.2 && <0.3'
  template-haskell: '>=2.19 && <2.24'
  temporary: '>=0'
  text: '>=2.0 && <2.2'
  time: '>=1.12 && <1.15'
  timers: '>=0.2 && <0.3'
  tls: '>=2.0 && <2.4'
  tls-session-manager: '>=0.0.5 && <0.1'
  transformers: '>=0.6 && <0.7'
  unix: '>=2.8 && <2.9'
  unliftio: '>=0.2 && <0.3'
  unordered-containers: '>=0.2 && <0.3'
  wai: '>=3.2 && <3.3'
  wai-extra: '>=3.1 && <3.2'
  warp: '>=3.4 && <3.5'
